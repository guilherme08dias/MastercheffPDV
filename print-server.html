<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Servidor de Impress√£o - XisMaster</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin: 0;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: bold;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .status.printing {
            background: #fff3cd;
            color: #856404;
        }

        .pulse {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .log {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-item {
            padding: 10px;
            border-left: 3px solid #667eea;
            margin-bottom: 10px;
            background: white;
            border-radius: 5px;
        }

        .log-time {
            font-size: 12px;
            color: #999;
        }

        .log-order {
            font-weight: bold;
            color: #333;
            margin: 5px 0;
        }

        .log-status {
            font-size: 12px;
            color: #28a745;
        }

        #print-area {
            display: none;
        }

        /* OTIMIZA√á√ÉO PARA IMPRESSORA T√âRMICA */
        @media print {
            @page {
                size: auto;
                margin: 0mm;
            }

            body {
                margin: 0;
                padding: 0;
                background: white;
            }

            body * {
                visibility: hidden;
            }

            #print-area,
            #print-area * {
                visibility: visible;
            }

            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                display: block;
                background: white;
                color: black;
                font-family: 'Arial', 'Helvetica', sans-serif;
            }
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>
            <span>üñ®Ô∏è</span>
            Servidor de Impress√£o Ativo
        </h1>
        <p style="color: #666; margin-bottom: 20px;">Aguardando pedidos do sistema XisMaster...</p>

        <div id="status" class="status disconnected">
            <div class="pulse"></div>
            <span>Conectando ao Supabase...</span>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="total-printed">0</div>
                <div class="stat-label">Pedidos Impressos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="session-printed">0</div>
                <div class="stat-label">Nesta Sess√£o</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="last-print-time">--:--</div>
                <div class="stat-label">√öltima Impress√£o</div>
            </div>
        </div>

        <h3 style="margin: 20px 0 10px 0; color: #333;">üìã Log de Impress√µes</h3>
        <div class="log" id="log">
            <p style="color: #999; text-align: center;">Nenhuma impress√£o ainda...</p>
        </div>

        <div class="footer">
            <p>XisMaster POS - Print Server v1.0</p>
            <p style="font-size: 12px; margin-top: 5px;">Mantenha esta p√°gina sempre aberta</p>
        </div>
    </div>

    <div id="print-area"></div>

    <script>
        const SUPABASE_URL = 'https://eilmnydyrvxtcwhsttqv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpbG1ueWR5cnZ4dGN3aHN0dHF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4Mzc3NTgsImV4cCI6MjA4MTQxMzc1OH0.MUn-LoPvR2BZ_9mwL21koTnc2KcQlj_ccW3bgBhWciE';

        let supabaseClient;
        let stats = { totalPrinted: 0, sessionPrinted: 0 };
        let deliveryAreasMap = {};

        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        const printArea = document.getElementById('print-area');

        function updateStatus(status, message) {
            statusEl.className = `status ${status}`;
            statusEl.innerHTML = `<div class="pulse"></div><span>${message}</span>`;
        }

        function addLog(orderNumber, customerName, status) {
            const timeStr = new Date().toLocaleTimeString('pt-BR');
            if (logEl.querySelector('p')) logEl.innerHTML = '';

            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            logItem.innerHTML = `
                <div class="log-time">${timeStr}</div>
                <div class="log-order">Pedido #${orderNumber} - ${customerName}</div>
                <div class="log-status">${status}</div>
            `;
            logEl.insertBefore(logItem, logEl.firstChild);
            while (logEl.children.length > 10) logEl.removeChild(logEl.lastChild);
        }

        function updateStats() {
            document.getElementById('last-print-time').textContent = new Date().toLocaleTimeString('pt-BR', {
                hour: '2-digit', minute: '2-digit'
            });
        }

        async function fetchDeliveryAreas() {
            try {
                const { data, error } = await supabaseClient.from('delivery_areas').select('id, name');
                if (data) {
                    data.forEach(area => (deliveryAreasMap[area.id] = area.name));
                    console.log('Bairros carregados:', Object.keys(deliveryAreasMap).length);
                }
            } catch (e) {
                console.error('Erro ao carregar bairros:', e);
            }
        }

        function formatOrderNumber(num) {
            return num === 13 ? '12+1' : num.toString();
        }

        // Fun√ß√£o auxiliar para buscar itens com retry
        async function fetchOrderItems(orderId, attempts = 3) {
            for (let i = 0; i < attempts; i++) {
                const { data: items, error } = await supabaseClient
                    .from('order_items')
                    .select('*, product:products(name)')
                    .eq('order_id', orderId);

                if (error) {
                    console.error('Erro ao buscar itens:', error);
                    return [];
                }

                if (items && items.length > 0) {
                    return items;
                }

                // Se n√£o encontrou itens, espera um pouco e tenta de novo (race condition)
                console.log(`Tentativa ${i + 1}: Itens n√£o encontrados, aguardando...`);
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            return [];
        }

        async function printOrder(order) {
            try {
                updateStatus('printing', `Imprimindo pedido #${formatOrderNumber(order.daily_number || order.id)}...`);

                // Busca itens com retry para garantir que foram inseridos
                const items = await fetchOrderItems(order.id);

                if (!items || items.length === 0) {
                    console.error('Pedido sem itens encontrado!');
                    // Mesmo sem itens, vamos imprimir para n√£o perder o pedido, mas com aviso
                }

                const formattedItems = items.map(item => ({
                    ...item,
                    product_name: item.product?.name || 'Produto'
                }));

                const neighborhoodName = order.neighborhood_id ? (deliveryAreasMap[order.neighborhood_id] || '') : '';

                const formatCurrency = (value) => `R$ ${value.toFixed(2)}`;
                const subtotal = formattedItems.reduce((acc, item) => acc + (item.unit_price * item.quantity), 0);

                // GERA√á√ÉO DO RECIBO - Layout condicional para pedidos web
                const isWebOrder = order.origin === 'web';
                const paymentLabels = {
                    'pix': 'üì± PIX',
                    'credit': 'üí≥ CART√ÉO',
                    'debit': 'üí≥ D√âBITO',
                    'cash': 'üíµ DINHEIRO'
                };
                const paymentLabel = paymentLabels[order.payment_method] || order.payment_method;

                // Extrair informa√ß√µes de troco e endere√ßo das notes dos itens (se web)
                let deliveryAddress = '';
                let changeInfo = '';
                if (isWebOrder && formattedItems.length > 0) {
                    const firstItemNotes = formattedItems[0]?.notes || '';
                    const addressMatch = firstItemNotes.match(/üìç\s*(.+?)(?:\s*\||$)/);
                    const changeMatch = firstItemNotes.match(/üíµ\s*Troco\s*p\/\s*R\$\s*(\d+)/);
                    if (addressMatch) deliveryAddress = addressMatch[1];
                    if (changeMatch) changeInfo = `Troco para R$ ${changeMatch[1]}`;
                }

                // Construir endere√ßo completo a partir dos campos estruturados
                let fullStructuredAddress = '';
                if (order.address_street) {
                    fullStructuredAddress = `${order.address_street}, ${order.address_number || 'S/N'}`;
                    if (order.address_complement) {
                        fullStructuredAddress += ` - ${order.address_complement}`;
                    }
                }
                // Priorizar endere√ßo estruturado sobre o extra√≠do das notes
                const finalDeliveryAddress = fullStructuredAddress || deliveryAddress;

                // GERA√á√ÉO DE QR CODES (apenas para pedidos web)
                let whatsappQrDataUrl = '';
                let mapsQrDataUrl = '';

                if (isWebOrder && order.customer_phone) {
                    try {
                        // QR Code para WhatsApp
                        const phone = order.customer_phone.replace(/\D/g, '');
                        const whatsappMsg = encodeURIComponent('Ol√°! Sou o entregador do MASTERCHEFF. Estou com o seu pedido! üçî');
                        const whatsappUrl = `https://wa.me/55${phone}?text=${whatsappMsg}`;

                        const qrWhatsapp = qrcode(0, 'L');
                        qrWhatsapp.addData(whatsappUrl);
                        qrWhatsapp.make();
                        whatsappQrDataUrl = qrWhatsapp.createDataURL(4);

                        // QR Code para Google Maps (Endere√ßo)
                        if (order.type === 'delivery') {
                            let mapsUrl = '';
                            // Prioridade: Endere√ßo Estruturado > GPS legado > Endere√ßo texto
                            if (order.address_street && order.neighborhood_id) {
                                mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(`${order.address_street}, ${order.address_number || ''}, ${deliveryAreasMap[order.neighborhood_id] || ''}, Chapec√≥, SC`)}`;
                            } else if (order.gps_lat && order.gps_lng) {
                                mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${order.gps_lat},${order.gps_lng}`;
                            } else if (deliveryAddress) {
                                mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(deliveryAddress)}`;
                            }

                            if (mapsUrl) {
                                const qrMaps = qrcode(0, 'L');
                                qrMaps.addData(mapsUrl);
                                qrMaps.make();
                                mapsQrDataUrl = qrMaps.createDataURL(4);
                            }
                        }
                    } catch (qrError) {
                        console.error('Erro ao gerar QR Code:', qrError);
                    }
                }

                // ============================================================
                // FUN√á√ÉO PARA GERAR HTML DO RECIBO
                // isMotoboyVia: true = Via do Motoboy (campos destacados)
                // ============================================================
                function generateReceiptHTML(isMotoboyVia = false) {
                    // Estilos condicionais para Via do Motoboy
                    const addressStyle = isMotoboyVia 
                        ? 'font-size: 18px; font-weight: 900; margin: 5px 0; background: #000; color: #fff; padding: 8px; border: 3px solid #000;'
                        : 'font-size: 14px; margin: 3px 0;';
                    const complementStyle = isMotoboyVia
                        ? 'font-size: 16px; font-weight: 900; margin: 5px 0; background: #eee; padding: 5px; border: 2px dashed #000;'
                        : 'font-size: 14px; margin: 3px 0;';
                    const totalStyle = isMotoboyVia
                        ? 'font-size: 32px; font-weight: 900; background: #000; color: #fff; padding: 10px;'
                        : 'font-size: 28px; font-weight: 900;';
                    const feeStyle = isMotoboyVia
                        ? 'font-weight: 900; font-size: 18px; background: #eee; padding: 5px;'
                        : 'font-weight: 800;';

                    return `
                    <div style="width: 72mm; margin: 0 auto; font-family: 'Arial', sans-serif; padding: 0; color: black; font-weight: bold;">
                        ${isMotoboyVia ? `
                            <div style="text-align: center; background: #000; color: #fff; padding: 15px; margin-bottom: 10px; border: 4px double #fff;">
                                <h2 style="font-size: 22px; font-weight: 900; margin: 0;">üõµ VIA DO MOTOBOY üõµ</h2>
                            </div>
                        ` : ''}
                        ${isWebOrder && !isMotoboyVia ? `
                            <div style="text-align: center; background: #000; color: #fff; padding: 10px; margin-bottom: 10px;">
                                <h2 style="font-size: 16px; font-weight: 900; margin: 0;">üåê PEDIDO VIA LINK</h2>
                            </div>
                        ` : ''}
                        
                        <div style="text-align: center; margin-bottom: 15px;">
                            <h2 style="font-size: 20px; font-weight: 900; text-transform: uppercase; margin: 0;">MASTERCHEFF</h2>
                            <p style="font-size: 14px; margin: 2px 0;">Food Truck</p>
                        </div>
                        
                        <div style="border-bottom: 2px dashed #000; margin: 10px 0;"></div>
                        
                        <div style="margin: 15px 0; text-align: center;">
                            <span style="font-size: 16px;">PEDIDO N√öMERO</span>
                            <h1 style="font-size: 48px; font-weight: 900; margin: 5px 0; line-height: 1;">
                                #${(order.daily_number || order.id || 0).toString().padStart(2, '0')}
                            </h1>
                        </div>
                        
                        <div style="margin-bottom: 15px; text-align: center;">
                            <p style="font-size: 22px; font-weight: 900; text-transform: uppercase; margin: 0;">${order.customer_name || 'Balc√£o'}</p>
                            ${isWebOrder && order.customer_phone ? `<p style="font-size: 14px; margin: 3px 0;">üìû ${order.customer_phone}</p>` : ''}
                            ${order.type === 'delivery' ? `
                                <p style="font-size: 18px; font-weight: 800; margin: 8px 0; background: #eee; padding: 5px;">üõµ ENTREGA</p>
                                ${finalDeliveryAddress ? `<p style="${addressStyle}">üìç ${finalDeliveryAddress}</p>` : ''}
                                ${order.address_complement ? `<p style="${complementStyle}">üè¢ APTO: ${order.address_complement}</p>` : ''}
                                ${neighborhoodName ? `<p style="font-size: 14px; margin: 3px 0;">üèòÔ∏è ${neighborhoodName}</p>` : ''}
                            ` : order.type === 'takeaway' ? `
                                <p style="font-size: 16px; font-weight: 800; margin: 5px 0;">üè™ RETIRADA NO LOCAL</p>
                            ` : ''}
                        </div>
                        
                        <div style="border-bottom: 2px dashed #000; margin: 10px 0;"></div>
                        
                        <div style="margin: 15px 0;">
                            ${formattedItems.length > 0 ? formattedItems.map(item => {
                    // Limpar notes (removendo info de entrega/obs/adicionais j√° listados)
                    let cleanNotes = item.notes || '';
                    cleanNotes = cleanNotes.replace(/üìç\s*.+?(\s*\||$)/g, '').replace(/üè™\s*Retirada(\s*\||$)/g, '').replace(/üíµ\s*Troco.+?(\s*\||$)/g, '').trim();
                    cleanNotes = cleanNotes.replace(/\+\s*[\w\s]+/g, '').replace(/\|\s*\|/g, '|').replace(/^\|\s*|\s*\|$/g, '').trim();

                    const totalAddonsPrice = item.addons_detail ? item.addons_detail.reduce((sum, a) => sum + (a.price || 0), 0) : 0;
                    const unitPriceBase = item.unit_price - totalAddonsPrice;

                    return `
                                    <div style="margin-bottom: 8px; border-bottom: 1px dotted #ccc; padding-bottom: 5px;">
                                        <div style="display: flex; justify-content: space-between; align-items: baseline; font-weight: 900; font-size: 16px;">
                                            <span style="flex: 1;">${item.quantity}x ${item.product_name}</span>
                                            <span style="font-size: 14px;">${formatCurrency(unitPriceBase * item.quantity)}</span>
                                        </div>
                                        ${item.addons_detail && item.addons_detail.length > 0 ?
                            item.addons_detail.map(addon => `
                                                <div style="display: flex; justify-content: space-between; font-size: 12px; color: #444; margin-left: 10px; margin-top: 2px;">
                                                    <span style="font-style: italic;">+ ${addon.name}</span>
                                                    <span style="font-style: italic;">${formatCurrency(addon.price * item.quantity)}</span>
                                                </div>
                                            `).join('')
                            : ''}
                                        ${cleanNotes ? `<div style="padding-left: 0px; font-size: 12px; margin-top: 2px; color: #000;"><p style="font-weight: normal; margin: 0; background: #eee; display: inline-block; padding: 2px 5px;">OBS: ${cleanNotes}</p></div>` : ''}
                                    </div>
                                `;
                }).join('') : '<p style="text-align:center; font-size: 14px;">(Sem itens para exibir)</p>'}
                        </div>
                        
                        <div style="border-bottom: 2px dashed #000; margin: 10px 0;"></div>
                        
                        <div style="font-size: 16px; margin: 15px 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: 800;">
                                <span>Subtotal</span>
                                <span>${formatCurrency(subtotal)}</span>
                            </div>
                            ${order.delivery_fee_snapshot > 0 ? `
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px; ${feeStyle}">
                                    <span>Taxa de Entrega</span>
                                    <span>${formatCurrency(order.delivery_fee_snapshot)}</span>
                                </div>
                            ` : ''}
                            <div style="display: flex; justify-content: space-between; margin-top: 10px; ${totalStyle}">
                                <span>TOTAL</span>
                                <span>${formatCurrency(order.total)}</span>
                            </div>
                        </div>
                        
                        ${isWebOrder || isMotoboyVia ? `
                            <div style="border-top: 2px dashed #000; padding-top: 10px; margin-top: 10px;">
                                <div style="display: flex; justify-content: space-between; font-size: 14px; font-weight: 800; margin-bottom: 5px;">
                                    <span>PAGAMENTO:</span>
                                    <span>${paymentLabel}</span>
                                </div>
                                ${changeInfo ? `
                                    <div style="display: flex; justify-content: space-between; font-size: ${isMotoboyVia ? '18px' : '14px'}; font-weight: 900; ${isMotoboyVia ? 'background: #000; color: #fff; padding: 8px;' : ''}">
                                        <span>TROCO:</span>
                                        <span>${changeInfo}</span>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}

                        ${whatsappQrDataUrl && !isMotoboyVia ? `
                            <div style="text-align: center; margin-top: 20px; border-top: 2px dashed #000; padding-top: 15px;">
                                <img src="${whatsappQrDataUrl}" style="width: 35mm; height: 35mm;" />
                                <p style="font-size: 10px; margin: 5px 0 0 0;">üì≤ SCAN PARA WHATSAPP</p>
                            </div>
                        ` : ''}

                        ${mapsQrDataUrl ? `
                            <div style="text-align: center; margin-top: 15px;">
                                <img src="${mapsQrDataUrl}" style="width: 35mm; height: 35mm;" />
                                <p style="font-size: 10px; margin: 5px 0 0 0;">üìç GPS ENTREGA</p>
                            </div>
                        ` : ''}
                        
                        <div style="margin-top: 30px; text-align: center; border-top: 2px dashed #000; padding-top: 10px;">
                            <p style="font-size: 12px; font-weight: 800; margin: 0;">${new Date().toLocaleString('pt-BR')}</p>
                            ${isMotoboyVia ? '<p style="font-size: 10px; margin: 5px 0 0 0;">--- VIA DO ENTREGADOR ---</p>' : ''}
                        </div>
                        
                        <!-- Espa√ßo final reduzido para corte -->
                        <div style="height: 5mm;"></div>
                    </div>
                `;
                }

                // ============================================================
                // L√ìGICA DE IMPRESS√ÉO: 2 VIAS PARA DELIVERY
                // ============================================================
                if (order.type === 'delivery') {
                    // VIA 1: Estabelecimento
                    printArea.innerHTML = generateReceiptHTML(false);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    window.print();
                    
                    // Aguardar entre impress√µes
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // VIA 2: Motoboy (com destaques)
                    printArea.innerHTML = generateReceiptHTML(true);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    window.print();
                } else {
                    // VIA √öNICA para pickup/local
                    printArea.innerHTML = generateReceiptHTML(false);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    window.print();
                }

                await supabaseClient
                    .from('orders')
                    .update({
                        printed: true,
                        printed_at: new Date().toISOString(),
                        print_attempts: (order.print_attempts || 0) + 1
                    })
                    .eq('id', order.id);

                stats.totalPrinted++;
                stats.sessionPrinted++;
                updateStats();
                addLog(formatOrderNumber(order.daily_number || order.id), order.customer_name || 'Balc√£o', order.type === 'delivery' ? '‚úÖ 2 vias impressas (Delivery)' : '‚úÖ Impresso com sucesso');
                updateStatus('connected', 'Conectado - Aguardando pedidos...');

            } catch (error) {
                console.error('Erro ao imprimir:', error);
                addLog(formatOrderNumber(order.daily_number || order.id), order.customer_name || 'Balc√£o', '‚ùå Erro na impress√£o');
                updateStatus('connected', 'Conectado - Erro na √∫ltima impress√£o');
            }
        }

        async function init() {
            try {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('‚úÖ Cliente Supabase criado');

                updateStatus('connected', 'Conectado - Aguardando pedidos...');
                fetchDeliveryAreas();

                // Buscar pedidos pendentes
                const { data: pendingOrders } = await supabaseClient
                    .from('orders')
                    .select('*')
                    .eq('printed', false)
                    .order('created_at', { ascending: true })
                    .limit(10);

                if (pendingOrders && pendingOrders.length > 0) {
                    console.log(`Encontrados ${pendingOrders.length} pedidos pendentes`);
                    for (const order of pendingOrders) {
                        await printOrder(order);
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }

                // Inscrever-se em novos pedidos
                supabaseClient
                    .channel('orders-channel')
                    .on('postgres_changes', {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'orders'
                    }, (payload) => {
                        console.log('Novo pedido recebido:', payload.new);
                        // Pequeno delay para garantir que os itens foram inseridos
                        setTimeout(() => printOrder(payload.new), 1000);
                    })
                    .on('postgres_changes', {
                        event: 'UPDATE',
                        schema: 'public',
                        table: 'orders',
                        filter: 'printed=eq.false'
                    }, (payload) => {
                        if (payload.new.printed === false && payload.old.printed === true) {
                            console.log('Reimpress√£o solicitada:', payload.new);
                            printOrder(payload.new);
                        }
                    })
                    .subscribe((status) => {
                        console.log('Status da inscri√ß√£o:', status);
                        if (status === 'SUBSCRIBED') {
                            console.log('‚úÖ Inscrito no canal de pedidos');
                        }
                    });

            } catch (error) {
                console.error('Erro ao inicializar:', error);
                updateStatus('disconnected', 'Erro ao conectar no Supabase');
            }
        }

        window.addEventListener('load', init);
    </script>
</body>

</html>